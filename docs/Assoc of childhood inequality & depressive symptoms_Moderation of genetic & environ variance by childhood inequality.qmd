---
title-block-banner: TRUE
title: "The Long Reach of Childhood Income Inequality: A Multinational Twin Study of Gene-Environment Interplay on Adult Depressive Symptoms"
subtitle: "Analytic code with outputs (R version 4.5.0)"
author: 
  - name: Andrew Petkus
    id: AP
    orcid: 0000-0002-7770-0123
    email: petkus@usc.edu
    affiliation: 
      - name: University of Southern California
        city: Los Angeles
        state: CA
date: "August 6, 2025"
abstract: "We examine the importance of childhood exposure to uneven distribution of income (i.e., income inequality) in shaping individual differences in adult depressive symptoms, and we test for interplay between genes and inequality using polygenic indices for major depressive disorder as well as estimates of genetic influences based on twin models. Research participants were 69,973 members of twin studies from four developed countries born between 1893 and 1979, and aged 26 to 103 at the time of assessment of depressive symptoms. Income inequality exposure was operationalized as the share of income accruing to the top 1% for each country when the participant was age 10. Income inequality exposure at age 10 was associated with depressive symptom scores in adulthood, adjusting for a host of covariates. Each 1% rise in inequality was associated with a 0.20 higher T-score standardized depressive symptom score. Further, genotyping was available for 6,251 participants. Interaction models showed that among men, but not women, a higher genetic index score for depression augmented the strength of the association between childhood income inequality and depressive symptoms. Twin models based on the entire analytic sample also showed that childhood income inequality moderated genetic variance underlying depressive symptoms, with higher heritability at higher levels of childhood income inequality. Results underscore the long reach of childhood exposure to income inequality and illustrate the interplay of genetic risk with adverse environmental exposures."
format:
  html:
    embed-resources: true
    toc: TRUE
    toc-location: body
editor: visual
echo: TRUE
df-print: kable
---

```{r}
#| label: Load R packages
#| warning: false
#| include: false
#| echo: false

rm(list=ls(all=TRUE))

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/manuscript/tbls_figs")

require(sas7bdat, quietly = TRUE)
require(psych, quietly = TRUE)
require(brolgar, quietly = TRUE)
require(nlive, quietly = TRUE)
require(gtsummary, quietly = TRUE)
require(ggplot2, quietly = TRUE)
require(reshape2, quietly = TRUE)
require(ddpcr, quietly=TRUE)
library(dplyr, quietly = TRUE)
require(gridExtra, quietly=TRUE)
library(simplecolors, quietly=TRUE)
require(grid,quietly=TRUE)
require(webshot2, quietly=TRUE)
require(ggtext,quietly=TRUE)
library("GGally", quietly=TRUE)
library(MplusTrees, quietly=TRUE)
library(rpart.plot)
library(lavaan, quietly=TRUE)
library(gt, quietly=TRUE)

```

## Transform depressive symptoms to reduce skewness

```{r}
#| label: Data wrangling prior to analysis
#| warning: false
#| fig-width: 12
#| fig-height: 12

# load igems depression data data ---------------------------------------------------------

data<-read.csv("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/data/igems_cross_22july2024.csv")

# transform depression variable to reduce skewness ------------------------

data$depression_sqrt<-sqrt(data$depression)
data$depZ<-as.numeric(scale(data$depression_sqrt))

data$depT<-(data$depZ*10)+50

```

## Main table 1: Descriptive statistics by country

```{r}
#| label: Generate descriptive table 1
#| warning: false


dtable <- data %>% select(age_dep, zygosC, sexF, depression, year10, yearDEP, depression, ineq10, gdp10,  isced, siops08, country2)

tbl<-dtable %>%
  tbl_summary(
    by = country2,
              type = list(age_dep ~ "continuous",
                 zygosC ~ "categorical",
                 sexF ~ "categorical",
                 depression ~ "continuous",
                 year10 ~ "continuous",
                 yearDEP ~ "continuous",
                 ineq10 ~ "continuous",
                 gdp10 ~ "continuous",
                 isced ~ "continuous",
                 siops08 ~ "continuous"),
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                               all_categorical() ~ "{p}% ({n})",
                               all_dichotomous() ~ "{p}% ({n})"),
    digits = list("age_dep" ~ 2,
                  "zygosC" ~ 0,
                  "sexF" ~ 0,
                  "depression" ~ 2,
                  "year10" ~0,
                  "yearDEP" ~0,
                  "ineq10" ~2,
                  "gdp10" ~2,
                  "isced" ~2,
                  "siops08" ~2),
    missing = "no",
    label = list(age_dep ~ "Age at first depressive symptom assessment",
                 zygosC ~ "Zygosity",
                 sexF ~ "Sex",
                 depression ~ "Harmonized depressive symptoms",
                 year10 ~ "Calendar year when 10 years old",
                 yearDEP ~ "Calendar year of depressive sx assessment",
                 ineq10 ~ "Top 1% index at age 10",
                 gdp10 ~ "Gross domestic product at age 10",
                 isced ~ "Educational attainment",
                 siops08 ~ "Occupational prestige")) %>% modify_header(label ~ "**Variable**")%>%
  modify_header(label ~ "**Variable**") %>%
  modify_spanning_header(c("stat_1", "stat_2","stat_3","stat_4") ~ "**Country**") %>%
  add_p(test = list(all_continuous() ~ "oneway.test", all_categorical() ~ "chisq.test"),
        pvalue_fun = ~ style_pvalue(.x, digits = 2)) %>%
  bold_p() %>%
  add_overall(last=FALSE)

tbl

# convert to tibble, then write to xlsx
tbl %>%
  gtsummary::as_tibble() %>% 
  writexl::write_xlsx(., "example_gtsummary1.xlsx")



```

## Correlation matrix and distribution of key variables by country

```{r}
#| warning: false
#| label: Correlation matrix by country
#| fig-width: 12
#| fig-height: 12

#correlation matrix

my_data <- dtable

ggpairs(my_data, columns = c(1,3:7), ggplot2::aes(colour=country2),
        lower = list(continuous = "density", combo = "box_no_facet"),
        columnLabels = c("Age","Sex","Raw depression", "Transformed dep", "Childhood inequality", "Current inequality")) 



```

## Phenotypic association between childhood inequality and depressive symptoms

### Base model including only covariates

We first examine the association between childhood inequality and depressive symptoms. Here we adjust for age via two age effects (effect of age before age 70 and effect of age after age 70). We chose this cutoff based on the Psychological Science paper.

The first model we ran included adjusting for the two age effects, education, and sex.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: Phenotypic analysis

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

data$s1<-ifelse(data$age_dep<70,data$age70,0)
data$s2<-ifelse(data$age_dep>=70, data$age70,0)
data$sex0<-data$sex-1
data$pairN<-paste(data$pairid,data$study,sep="_")
data$X.1<-NULL
data$X<-NULL

pheno1<-mplusObject(
  TITLE = "model 1 only age and sex on dep",
  
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2
  sex0 isced ;

cluster is pairN;

  ",
  
  
  ANALYSIS="

ESTIMATOR=MLR;  
TYPE= COMPLEX; 
  

",
  MODEL= "

depT on s1
s2 sex0 isced;

  ",
  
  
  
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno1_out <- mplusModeler(pheno1, 
                         dataout="igems phenotypic analysis.dat",
                         hashfilename = FALSE,
                         modelout = "model 1 age and sex on dep.inp", 
                         run = 1, 
                         writeData=c("always"))

```

```{r}
#| label: Phenotypic analysis summary table
 
##output paramater estiamtes from this model

tbl1<-data.frame(effect= c("Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Female",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 N=pheno1_out$results$summaries$Observations,
                 estimate=c(pheno1_out$results$parameters$unstandardized[1,3],
                            pheno1_out$results$parameters$unstandardized[2,3],
                            pheno1_out$results$parameters$unstandardized[3,3],
                            pheno1_out$results$parameters$unstandardized[4,3],
                            pheno1_out$results$parameters$unstandardized[5,3],
                            pheno1_out$results$parameters$unstandardized[6,3]),
                 low=c(pheno1_out$results$parameters$ci.unstandardized[1,4],
                       pheno1_out$results$parameters$ci.unstandardized[2,4],
                       pheno1_out$results$parameters$ci.unstandardized[3,4],
                       pheno1_out$results$parameters$ci.unstandardized[4,4],
                       pheno1_out$results$parameters$ci.unstandardized[5,4],
                       pheno1_out$results$parameters$ci.unstandardized[6,4]),
                 upp=c(pheno1_out$results$parameters$ci.unstandardized[1,8],
                       pheno1_out$results$parameters$ci.unstandardized[2,8],
                       pheno1_out$results$parameters$ci.unstandardized[3,8],
                       pheno1_out$results$parameters$ci.unstandardized[4,8],
                       pheno1_out$results$parameters$ci.unstandardized[5,8],
                       pheno1_out$results$parameters$ci.unstandardized[6,8]),
                 p=c(pheno1_out$results$parameters$unstandardized[1,6],
                            pheno1_out$results$parameters$unstandardized[2,6],
                            pheno1_out$results$parameters$unstandardized[3,6],
                            pheno1_out$results$parameters$unstandardized[4,6],
                            pheno1_out$results$parameters$unstandardized[5,6],
                            pheno1_out$results$parameters$unstandardized[6,6]),
                 r2=pheno1_out$results$parameters$r2[1,2])
  
tbl1


```

### Add the effect of childhood inequality on depressive symptoms

The second model constructed included a main effect of childhood (age 10) inequality (per 1% increase in the 99% inequality measure).

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: phenotypic analysis with conflict

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

data$ineq10c<-data$ineq10-10

pheno2<-mplusObject(
  TITLE = "model 2 add childhood inequality",
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  isced ineq10c ;
cluster is pairN;",
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; ",
  MODEL= "
depT on s1
s2 sex0 
isced ineq10c;",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno2_out <- mplusModeler(pheno2, 
                         dataout="igems phenotypic analysis.dat",
                         hashfilename = FALSE,
                         modelout = "model 2 childhood ineq.inp", 
                         run = 1, 
                         writeData=c("always"))
```

```{r}

##output paramater estiamtes from this model

tbl2<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Female",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 N=pheno2_out$results$summaries$Observations,
                 estimate=c(pheno2_out$results$parameters$unstandardized[5,3],
                            pheno2_out$results$parameters$unstandardized[1,3],
                            pheno2_out$results$parameters$unstandardized[2,3],
                            pheno2_out$results$parameters$unstandardized[3,3],
                            pheno2_out$results$parameters$unstandardized[4,3],
                            pheno2_out$results$parameters$unstandardized[6,3],
                            pheno2_out$results$parameters$unstandardized[7,3]),
                 low=c(pheno2_out$results$parameters$ci.unstandardized[5,4],
                       pheno2_out$results$parameters$ci.unstandardized[1,4],
                       pheno2_out$results$parameters$ci.unstandardized[2,4],
                       pheno2_out$results$parameters$ci.unstandardized[3,4],
                       pheno2_out$results$parameters$ci.unstandardized[4,4],
                       pheno2_out$results$parameters$ci.unstandardized[6,4],
                       pheno2_out$results$parameters$ci.unstandardized[7,4]),
                 upp=c(pheno2_out$results$parameters$ci.unstandardized[5,8],
                       pheno2_out$results$parameters$ci.unstandardized[1,8],
                       pheno2_out$results$parameters$ci.unstandardized[2,8],
                       pheno2_out$results$parameters$ci.unstandardized[3,8],
                       pheno2_out$results$parameters$ci.unstandardized[4,8],
                       pheno2_out$results$parameters$ci.unstandardized[6,8],
                       pheno2_out$results$parameters$ci.unstandardized[7,8]),
                 
                 p=c(pheno2_out$results$parameters$unstandardized[5,6],
                            pheno2_out$results$parameters$unstandardized[1,6],
                            pheno2_out$results$parameters$unstandardized[2,6],
                            pheno2_out$results$parameters$unstandardized[3,6],
                            pheno2_out$results$parameters$unstandardized[4,6],
                            pheno2_out$results$parameters$unstandardized[6,6],
                            pheno2_out$results$parameters$unstandardized[7,6]),
                 r2=pheno2_out$results$parameters$r2[1,2])
  
tbl2

```

### Summary of the phenotypic association between childhood inequality and depressive symptoms

There is an adverse association between childhood inequality and depressive symptoms. One percent increase in the 99% index of inequality in childhood was associated with an .202 T-score increase in depressive symptoms (adjusting for age, sex, and obtained education). The effect of childhood inequality was small explaining approximately .002 percent of the variance in depressive symptoms.

## Does sex, childhood GDP, or educational attainment moderate the effect of childhood inequality on depressive symptoms.

Previous studies suggest that income inequality may negatively impact men more than women, may be worse for individuals in poorer countries (low GDP), and be moderated by educational attainment. I examined the extent to which these factors moderate the adverse effect childhood inequality on depressive symptoms.

### Moderation by sex

I first ran the regression model adding a sex X inequality interaction term to the model.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: sex X inequality

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

data$inXsex<-data$ineq10c*data$sex0

pheno3<-mplusObject(
  TITLE = "model 3 sexXchildhood",
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  isced ineq10c
  inXsex;
cluster is pairN;",
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; ",
  MODEL= "
depT on s1
s2 sex0 
isced ineq10c
inXsex;",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno3_out <- mplusModeler(pheno3, 
                         dataout="igems phenotypic analysis.dat",
                         hashfilename = FALSE,
                         modelout = "model 3 ineqXsex.inp", 
                         run = 1, 
                         writeData=c("always"))

```

```{r}

##output paramater estiamtes from this model

tbl3<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                           "Female",
                           "Female x inequality",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 N=pheno3_out$results$summaries$Observations,
                 estimate=c(pheno3_out$results$parameters$unstandardized[5,3],
                            pheno3_out$results$parameters$unstandardized[3,3],
                            pheno3_out$results$parameters$unstandardized[6,3],
                            pheno3_out$results$parameters$unstandardized[1,3],
                            pheno3_out$results$parameters$unstandardized[2,3],
                            pheno3_out$results$parameters$unstandardized[4,3],
                            pheno3_out$results$parameters$unstandardized[7,3],
                            pheno3_out$results$parameters$unstandardized[8,3]),
                 
                 low=c(pheno3_out$results$parameters$ci.unstandardized[5,4],
                       pheno3_out$results$parameters$ci.unstandardized[3,4],
                       pheno3_out$results$parameters$ci.unstandardized[6,4],
                       pheno3_out$results$parameters$ci.unstandardized[1,4],
                       pheno3_out$results$parameters$ci.unstandardized[2,4],
                       pheno3_out$results$parameters$ci.unstandardized[4,4],
                       pheno3_out$results$parameters$ci.unstandardized[7,4],
                       pheno3_out$results$parameters$ci.unstandardized[8,4]),
                 
                 upp=c(pheno3_out$results$parameters$ci.unstandardized[5,8],
                       pheno3_out$results$parameters$ci.unstandardized[3,8],
                       pheno3_out$results$parameters$ci.unstandardized[6,8],
                       pheno3_out$results$parameters$ci.unstandardized[1,8],
                       pheno3_out$results$parameters$ci.unstandardized[2,8],
                       pheno3_out$results$parameters$ci.unstandardized[4,8],
                       pheno3_out$results$parameters$ci.unstandardized[7,8],
                       pheno3_out$results$parameters$ci.unstandardized[8,8]),
                 
                 p=c(pheno3_out$results$parameters$unstandardized[5,6],
                            pheno3_out$results$parameters$unstandardized[3,6],
                            pheno3_out$results$parameters$unstandardized[6,6],
                            pheno3_out$results$parameters$unstandardized[1,6],
                            pheno3_out$results$parameters$unstandardized[2,6],
                            pheno3_out$results$parameters$unstandardized[4,6],
                            pheno3_out$results$parameters$unstandardized[7,6],
                            pheno3_out$results$parameters$unstandardized[8,6]),
                 r2=pheno3_out$results$parameters$r2[1,2])
  
tbl3


```

Sex moderated the effect of childhood income inequality on depressive symptoms. The adverse effect of childhood inequality on depressive symptoms was of smaller magnitude for women compared to men. To visualize this interaction I ran a multi-group SEM stratified on sex to examine the effect size of childhood inequality for men and women separately.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: stratified by sex

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

pheno4<-mplusObject(
  TITLE = "model 4 childhood inequality stratified by sex;",
  
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex
  isced ineq10c;
  grouping is sex (1=men,2=women);
cluster is pairN;",
  
  
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; 

",
  MODEL= "

depT on s1 (m1)
s2 (m2)
isced (m3)
ineq10c (m4);

Model women:

depT on s1 (w1)
s2 (w2)
isced (w3)
ineq10c (w4);",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno4_out <- mplusModeler(pheno4, 
                          dataout="income inequality.dat",
                          hashfilename = FALSE,
                          modelout = "model 4 sex stratification.inp", 
                          run = 1, 
                          writeData=c("always"))
```

```{r}
#| label: sex stratified estimates and graph

tbl4<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 men_N=34423,
                 men_estimate=c(pheno4_out$results$parameters$unstandardized[4,3],
                            pheno4_out$results$parameters$unstandardized[1,3],
                            pheno4_out$results$parameters$unstandardized[2,3],
                            pheno4_out$results$parameters$unstandardized[3,3],
                            pheno4_out$results$parameters$unstandardized[5,3],
                            pheno4_out$results$parameters$unstandardized[6,3]),
                 
                 men_p=c(pheno4_out$results$parameters$unstandardized[4,6],
                            pheno4_out$results$parameters$unstandardized[1,6],
                            pheno4_out$results$parameters$unstandardized[2,6],
                            pheno4_out$results$parameters$unstandardized[3,6],
                            pheno4_out$results$parameters$unstandardized[5,6],
                            pheno4_out$results$parameters$unstandardized[6,6]),
                 women_estimate=c(pheno4_out$results$parameters$unstandardized[10,3],
                            pheno4_out$results$parameters$unstandardized[7,3],
                            pheno4_out$results$parameters$unstandardized[8,3],
                            pheno4_out$results$parameters$unstandardized[9,3],
                            pheno4_out$results$parameters$unstandardized[11,3],
                            pheno4_out$results$parameters$unstandardized[12,3]),
                 
                 women_p=c(pheno4_out$results$parameters$unstandardized[10,6],
                            pheno4_out$results$parameters$unstandardized[7,6],
                            pheno4_out$results$parameters$unstandardized[8,6],
                            pheno4_out$results$parameters$unstandardized[9,6],
                            pheno4_out$results$parameters$unstandardized[11,6],
                            pheno4_out$results$parameters$unstandardized[12,6]))

tbl4


##generate forest plot to visualize the interaction

label <- c("men","women")
mean  <- c(pheno4_out$results$parameters$unstandardized[4,3],
           pheno4_out$results$parameters$unstandardized[10,3]) 
lower <- c(pheno4_out$results$parameters$ci.unstandardized[4,4],
           pheno4_out$results$parameters$ci.unstandardized[10,4])
upper <- c(pheno4_out$results$parameters$ci.unstandardized[4,8],
           pheno4_out$results$parameters$ci.unstandardized[10,8])

df <- data.frame(label, mean, lower, upper)

# reverses the factor level ordering for labels after coord_flip()
df$label <- factor(df$label, levels=rev(df$label))

library(ggplot2)
fp <- ggplot(data=df, aes(x=label, y=mean, ymin=lower, ymax=upper, label=mean)) +
  geom_pointrange() + 
  geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  xlab("") + ylab("Effect of childhood inequality (95% CI)") +
  geom_text(vjust = -1, nudge_y = 0)+
  theme_bw() +
    theme(legend.box.background=element_blank(),
        legend.background=element_rect(fill="transparent",size=.5),
        axis.text.x=element_text(colour="black", size=18),
        axis.text.y=element_text(colour="black", size=18),
        axis.title.x=element_text(colour="black", size=18),
        axis.title.y=element_text(colour="black", size=18),
        plot.title=element_text(size=18),
        panel.background=element_blank(),
     #   panel.grid.major=element_blank(),
    #    panel.grid.minor=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.major.y=element_blank(),
    #    panel.grid.major.x=element_blank(),
    #    panel.grid.minor.x=element_blank(),
        panel.border=element_rect(colour="black", size=1),
        strip.background=element_blank(),
        strip.text=element_text(size=18),
        axis.line.x=element_line(size=1),
        axis.line.y=element_line(size=1),
        legend.text=element_text(size=18),
        legend.key.width=unit(3,"line"),
        legend.title=element_blank(),
        legend.direction="vertical",
        #       plot.title= element_text(hjust=-.45, vjust=2.12),
        legend.position=c("bottom"),
        legend.key=element_blank())# use a white background
print(fp)


```

### Moderation by childhood GDP

I ran a regression model adding the main effect of childhood GDP and GDPxInequality interaction.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: gdp by inequality

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

data$gdp10c<-(data$gdp10-12500)/1000

data$inXgdp<-data$ineq10c*data$gdp10c

pheno5<-mplusObject(
  TITLE = "model 5 gdpXchildhood",
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  isced
  gdp10c ineq10c
  inXgdp;
cluster is pairN;",
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; ",
  MODEL= "
depT on s1
s2 sex0
isced
gdp10c ineq10c
inXgdp;",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno5_out <- mplusModeler(pheno5, 
                         dataout="igems phenotypic analysis.dat",
                         hashfilename = FALSE,
                         modelout = "model 5 ineqXgdp.inp", 
                         run = 1, 
                         writeData=c("always"))

```

```{r}
#| label: output parameter estimates from gdp by inequality
##output paramater estiamtes from this model

tbl5<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                           "Childhood GDP (per 1,000 increase)",
                           "GDP x inequality",
                           "Female",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 N=pheno5_out$results$summaries$Observations,
                 estimate=c(pheno5_out$results$parameters$unstandardized[6,3],
                            pheno5_out$results$parameters$unstandardized[5,3],
                            pheno5_out$results$parameters$unstandardized[7,3],
                            pheno5_out$results$parameters$unstandardized[3,3],
                            pheno5_out$results$parameters$unstandardized[1,3],
                            pheno5_out$results$parameters$unstandardized[2,3],
                            pheno5_out$results$parameters$unstandardized[4,3],
                            pheno5_out$results$parameters$unstandardized[8,3],
                            pheno5_out$results$parameters$unstandardized[9,3]),
                 
                 low=c(pheno5_out$results$parameters$ci.unstandardized[6,4],
                       pheno5_out$results$parameters$ci.unstandardized[5,4],
                       pheno5_out$results$parameters$ci.unstandardized[7,4],
                       pheno5_out$results$parameters$ci.unstandardized[3,4],
                       pheno5_out$results$parameters$ci.unstandardized[1,4],
                       pheno5_out$results$parameters$ci.unstandardized[2,4],
                       pheno5_out$results$parameters$ci.unstandardized[4,4],
                       pheno5_out$results$parameters$ci.unstandardized[8,4],
                       pheno5_out$results$parameters$ci.unstandardized[9,4]),
                 
                 upp=c(pheno5_out$results$parameters$ci.unstandardized[6,8],
                       pheno5_out$results$parameters$ci.unstandardized[5,8],
                       pheno5_out$results$parameters$ci.unstandardized[7,8],
                       pheno5_out$results$parameters$ci.unstandardized[3,8],
                       pheno5_out$results$parameters$ci.unstandardized[1,8],
                       pheno5_out$results$parameters$ci.unstandardized[2,8],
                       pheno5_out$results$parameters$ci.unstandardized[4,8],
                       pheno5_out$results$parameters$ci.unstandardized[8,8],
                       pheno5_out$results$parameters$ci.unstandardized[9,8]),
                 
                 p=c(pheno5_out$results$parameters$unstandardized[6,6],
                            pheno5_out$results$parameters$unstandardized[5,6],
                            pheno5_out$results$parameters$unstandardized[7,6],
                            pheno5_out$results$parameters$unstandardized[3,6],
                            pheno5_out$results$parameters$unstandardized[1,6],
                            pheno5_out$results$parameters$unstandardized[2,6],
                            pheno5_out$results$parameters$unstandardized[4,6],
                            pheno5_out$results$parameters$unstandardized[8,6],
                            pheno5_out$results$parameters$unstandardized[9,6]),
                 r2=pheno5_out$results$parameters$r2[1,2])
  
tbl5


```

Country level childhood GDP moderated the effect of childhood income inequality on depressive symptoms. The adverse effect of childhood inequality on depressive symptoms was of smaller magnitude when they grew up in higher GDPs. To visualize this interaction I ran a multi-group SEM stratified on GDP (divided into quartiles) to examine the effect size of childhood inequality by GDP.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: gdp stratified model
setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")



data$gdpG[data$gdp10<=8864]<-1
data$gdpG[data$gdp10>8864 & data$gdp10<=12070]<-2
data$gdpG[data$gdp10>12070 & data$gdp10<=15436]<-3
data$gdpG[data$gdp10>15436]<-4

pheno6<-mplusObject(
  TITLE = "model 6 childhood inequality stratified by childhood GDP;",
  
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  gdpG
  isced ineq10c;
  grouping is gdpG (1=gdp_low_25,2= gdp_25to50,
  3= gdp_50to75, 4= gdp_high_75);
cluster is pairN;",
  
  
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; 

",
  MODEL= "

depT on s1 (m1a)
s2 (m2a)
sex0 (m5a)
isced (m3a)
ineq10c (m4a);

Model gdp_25to50:

depT on s1 (m1b)
s2 (m2b)
sex0 (m5b)
isced (m3b)
ineq10c (m4b);

Model gdp_50to75:

depT on s1 (m1c)
s2 (m2c)
sex0 (m5c)
isced (m3c)
ineq10c (m4c);

Model gdp_high_75:

depT on s1 (m1d)
s2 (m2d)
sex0 (m5d)
isced (m3d)
ineq10c (m4d);


",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno6_out <- mplusModeler(pheno6, 
                          dataout="income inequality.dat",
                          hashfilename = FALSE,
                          modelout = "model 6 gdp stratification.inp", 
                          run = 1, 
                          writeData=c("always"))

```

```{r}
#| label: parameter estimates stratified model and graph
tbl6<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Female",
                           "Education (per 1 isced increase)",
                           "intercept",
                           "residual"),
                 q1_N=17778,
                 q1_estimate=c(pheno6_out$results$parameters$unstandardized[5,3],
                            pheno6_out$results$parameters$unstandardized[1,3],
                            pheno6_out$results$parameters$unstandardized[2,3],
                            pheno6_out$results$parameters$unstandardized[3,3],
                            pheno6_out$results$parameters$unstandardized[4,3],
                            pheno6_out$results$parameters$unstandardized[6,3],
                            pheno6_out$results$parameters$unstandardized[7,3]),
                 
                 q1_p=c(pheno6_out$results$parameters$unstandardized[5,6],
                            pheno6_out$results$parameters$unstandardized[1,6],
                            pheno6_out$results$parameters$unstandardized[2,6],
                            pheno6_out$results$parameters$unstandardized[3,6],
                            pheno6_out$results$parameters$unstandardized[4,6],
                            pheno6_out$results$parameters$unstandardized[6,6],
                            pheno6_out$results$parameters$unstandardized[7,6]),
                 
                 q2_N=17596,
                 q2_estimate=c(pheno6_out$results$parameters$unstandardized[12,3],
                            pheno6_out$results$parameters$unstandardized[8,3],
                            pheno6_out$results$parameters$unstandardized[9,3],
                            pheno6_out$results$parameters$unstandardized[10,3],
                            pheno6_out$results$parameters$unstandardized[11,3],
                            pheno6_out$results$parameters$unstandardized[13,3],
                            pheno6_out$results$parameters$unstandardized[14,3]),
                 
                 q2_p=c(pheno6_out$results$parameters$unstandardized[12,6],
                            pheno6_out$results$parameters$unstandardized[8,6],
                            pheno6_out$results$parameters$unstandardized[9,6],
                            pheno6_out$results$parameters$unstandardized[10,6],
                            pheno6_out$results$parameters$unstandardized[11,6],
                            pheno6_out$results$parameters$unstandardized[13,6],
                            pheno6_out$results$parameters$unstandardized[14,6]),
                 
                 q3_N=17799,
                 q3_estimate=c(pheno6_out$results$parameters$unstandardized[19,3],
                            pheno6_out$results$parameters$unstandardized[15,3],
                            pheno6_out$results$parameters$unstandardized[16,3],
                            pheno6_out$results$parameters$unstandardized[17,3],
                            pheno6_out$results$parameters$unstandardized[18,3],
                            pheno6_out$results$parameters$unstandardized[20,3],
                            pheno6_out$results$parameters$unstandardized[21,3]),
                 q3_p=c(pheno6_out$results$parameters$unstandardized[19,6],
                            pheno6_out$results$parameters$unstandardized[15,6],
                            pheno6_out$results$parameters$unstandardized[16,6],
                            pheno6_out$results$parameters$unstandardized[17,6],
                            pheno6_out$results$parameters$unstandardized[18,6],
                            pheno6_out$results$parameters$unstandardized[20,6],
                            pheno6_out$results$parameters$unstandardized[21,6]),
                 q4_N=16800,
                 q4_estimate=c(pheno6_out$results$parameters$unstandardized[26,3],
                            pheno6_out$results$parameters$unstandardized[22,3],
                            pheno6_out$results$parameters$unstandardized[23,3],
                            pheno6_out$results$parameters$unstandardized[24,3],
                            pheno6_out$results$parameters$unstandardized[25,3],
                            pheno6_out$results$parameters$unstandardized[27,3],
                            pheno6_out$results$parameters$unstandardized[28,3]),
                 q4_p=c(pheno6_out$results$parameters$unstandardized[26,6],
                            pheno6_out$results$parameters$unstandardized[22,6],
                            pheno6_out$results$parameters$unstandardized[23,6],
                            pheno6_out$results$parameters$unstandardized[24,6],
                            pheno6_out$results$parameters$unstandardized[25,6],
                            pheno6_out$results$parameters$unstandardized[27,6],
                            pheno6_out$results$parameters$unstandardized[28,6]))

tbl6


##generate forest plot to visualize the interaction

label <- c("lowest 25%","25 to 50%","50 to 75%","highest 75%")
mean  <- c(pheno6_out$results$parameters$unstandardized[5,3],
           pheno6_out$results$parameters$unstandardized[12,3],
           pheno6_out$results$parameters$unstandardized[19,3],
           pheno6_out$results$parameters$unstandardized[26,3]) 
lower <- c(pheno6_out$results$parameters$ci.unstandardized[5,4],
           pheno6_out$results$parameters$ci.unstandardized[12,4],
           pheno6_out$results$parameters$ci.unstandardized[19,4],
           pheno6_out$results$parameters$ci.unstandardized[26,4])
upper <- c(pheno6_out$results$parameters$ci.unstandardized[5,8],
           pheno6_out$results$parameters$ci.unstandardized[12,8],
           pheno6_out$results$parameters$ci.unstandardized[19,8],
           pheno6_out$results$parameters$ci.unstandardized[26,8])

df <- data.frame(label, mean, lower, upper)

# reverses the factor level ordering for labels after coord_flip()
df$label <- factor(df$label, levels=rev(df$label))

library(ggplot2)
fp <- ggplot(data=df, aes(x=label, y=mean, ymin=lower, ymax=upper, label=mean)) +
  geom_pointrange() + 
  geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  xlab("") + ylab("Effect of childhood inequality (95% CI)") +
  geom_text(vjust = -1, nudge_y = 0)+
  theme_bw() +
    theme(legend.box.background=element_blank(),
        legend.background=element_rect(fill="transparent",size=.5),
        axis.text.x=element_text(colour="black", size=18),
        axis.text.y=element_text(colour="black", size=18),
        axis.title.x=element_text(colour="black", size=18),
        axis.title.y=element_text(colour="black", size=18),
        plot.title=element_text(size=18),
        panel.background=element_blank(),
     #   panel.grid.major=element_blank(),
    #    panel.grid.minor=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.major.y=element_blank(),
    #    panel.grid.major.x=element_blank(),
    #    panel.grid.minor.x=element_blank(),
        panel.border=element_rect(colour="black", size=1),
        strip.background=element_blank(),
        strip.text=element_text(size=18),
        axis.line.x=element_line(size=1),
        axis.line.y=element_line(size=1),
        legend.text=element_text(size=18),
        legend.key.width=unit(3,"line"),
        legend.title=element_blank(),
        legend.direction="vertical",
        #       plot.title= element_text(hjust=-.45, vjust=2.12),
        legend.position=c("bottom"),
        legend.key=element_blank())# use a white background


print(fp)


```

### Moderation by obtained education

I ran a regression model examining the education x inequality interaction.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: education by inequality

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")

data$edu3<-(data$isced-3)

data$inXedu<-data$ineq10c*data$edu3

pheno7<-mplusObject(
  TITLE = "model 7 educationXchildhood",
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  isced
  ineq10c
  inXedu;
cluster is pairN;",
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; ",
  MODEL= "
depT on s1
s2 sex0
isced
ineq10c
inXedu;",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno7_out <- mplusModeler(pheno7, 
                         dataout="igems phenotypic analysis.dat",
                         hashfilename = FALSE,
                         modelout = "model 7 ineqXedu.inp", 
                         run = 1, 
                         writeData=c("always"))
```

```{r}
#| label: parameter estimates edu by inequality

##output paramater estiamtes from this model

tbl7<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                           "Education (per 1 isced increase)",
                           "Education x inequality",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                         "Female",
                           "intercept",
                           "residual"),
                 N=pheno7_out$results$summaries$Observations,
                 estimate=c(pheno7_out$results$parameters$unstandardized[5,3],
                            pheno7_out$results$parameters$unstandardized[4,3],
                            pheno7_out$results$parameters$unstandardized[6,3],
                            pheno7_out$results$parameters$unstandardized[1,3],
                            pheno7_out$results$parameters$unstandardized[2,3],
                            pheno7_out$results$parameters$unstandardized[3,3],
                            pheno7_out$results$parameters$unstandardized[7,3],
                            pheno7_out$results$parameters$unstandardized[8,3]),
                 
                 low=c(pheno7_out$results$parameters$ci.unstandardized[5,4],
                       pheno7_out$results$parameters$ci.unstandardized[4,4],
                       pheno7_out$results$parameters$ci.unstandardized[6,4],
                       pheno7_out$results$parameters$ci.unstandardized[1,4],
                       pheno7_out$results$parameters$ci.unstandardized[2,4],
                       pheno7_out$results$parameters$ci.unstandardized[3,4],
                       pheno7_out$results$parameters$ci.unstandardized[7,4],
                       pheno7_out$results$parameters$ci.unstandardized[8,4]),
                 
                 upp=c(pheno7_out$results$parameters$ci.unstandardized[5,8],
                       pheno7_out$results$parameters$ci.unstandardized[4,8],
                       pheno7_out$results$parameters$ci.unstandardized[6,8],
                       pheno7_out$results$parameters$ci.unstandardized[1,8],
                       pheno7_out$results$parameters$ci.unstandardized[2,8],
                       pheno7_out$results$parameters$ci.unstandardized[3,8],
                       pheno7_out$results$parameters$ci.unstandardized[7,8],
                       pheno7_out$results$parameters$ci.unstandardized[8,8]),
                 
                 p=c(pheno7_out$results$parameters$unstandardized[5,6],
                            pheno7_out$results$parameters$unstandardized[4,6],
                            pheno7_out$results$parameters$unstandardized[6,6],
                            pheno7_out$results$parameters$unstandardized[1,6],
                            pheno7_out$results$parameters$unstandardized[2,6],
                            pheno7_out$results$parameters$unstandardized[3,6],
                            pheno7_out$results$parameters$unstandardized[7,6],
                            pheno7_out$results$parameters$unstandardized[8,6]),
                 r2=pheno7_out$results$parameters$r2[1,2])
  
tbl7

```

Educational attainment significantly moderated effect of childhood income inequality on depressive symptoms. The adverse effect of childhood inequality on depressive symptoms was of smaller magnitude when in individuals with more educational attainment. To visualize this interaction I ran a multi-group SEM stratified on educational attainment to examine the effect size of childhood inequality by GDP.

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: edu stratified model

setwd("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/phenotypic analyses")


pheno8<-mplusObject(
  TITLE = "model 8 childhood inequality stratified by education;",
  
  VARIABLE = "
  USEVARIABLES=
  depT s1
  s2 sex0
  eduC
  ineq10c;
  grouping is eduC (1=edu_0to2,2= edu_3to5,
  3= edu_6);
cluster is pairN;",
  
  
  ANALYSIS="
ESTIMATOR=MLR;  
TYPE= COMPLEX; 

",
  MODEL= "

depT on s1 (m1a)
s2 (m2a)
sex0 (m5a)
ineq10c (m4a);

Model edu_3to5:

depT on s1 (m1b)
s2 (m2b)
sex0 (m5b)
ineq10c (m4b);

Model edu_6:

depT on s1 (m1c)
s2 (m2c)
sex0 (m5c)
ineq10c (m4c);

",
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

pheno8_out <- mplusModeler(pheno8, 
                          dataout="income inequality.dat",
                          hashfilename = FALSE,
                          modelout = "model 8 edu stratification.inp", 
                          run = 1, 
                          writeData=c("always"))
```

```{r}
#| label: parameter estimates edu stratified model
tbl8<-data.frame(effect= c("Childhood inequality (per 1% increase)",
                         "Younger than 70 age effect",
                           "Older than 70 age effect",
                           "Female",
                           "intercept",
                           "residual"),
                 ed1_N=31965,
                 ed1_estimate=c(pheno8_out$results$parameters$unstandardized[4,3],
                            pheno8_out$results$parameters$unstandardized[1,3],
                            pheno8_out$results$parameters$unstandardized[2,3],
                            pheno8_out$results$parameters$unstandardized[3,3],
                            pheno8_out$results$parameters$unstandardized[5,3],
                            pheno8_out$results$parameters$unstandardized[6,3]),
                 
                 ed1_p=c(pheno8_out$results$parameters$unstandardized[4,6],
                            pheno8_out$results$parameters$unstandardized[1,6],
                            pheno8_out$results$parameters$unstandardized[2,6],
                            pheno8_out$results$parameters$unstandardized[3,6],
                            pheno8_out$results$parameters$unstandardized[5,6],
                            pheno8_out$results$parameters$unstandardized[6,6]),
                 
                 ed2_N=24108,
                 ed2_estimate=c(pheno8_out$results$parameters$unstandardized[10,3],
                            pheno8_out$results$parameters$unstandardized[7,3],
                            pheno8_out$results$parameters$unstandardized[8,3],
                            pheno8_out$results$parameters$unstandardized[9,3],
                            pheno8_out$results$parameters$unstandardized[11,3],
                            pheno8_out$results$parameters$unstandardized[12,3]),
                 
                 ed2_p=c(pheno8_out$results$parameters$unstandardized[10,6],
                            pheno8_out$results$parameters$unstandardized[7,6],
                            pheno8_out$results$parameters$unstandardized[8,6],
                            pheno8_out$results$parameters$unstandardized[9,6],
                            pheno8_out$results$parameters$unstandardized[11,6],
                            pheno8_out$results$parameters$unstandardized[12,6]),
                 
                 ed3_N=13900,
                 ed3_estimate=c(pheno8_out$results$parameters$unstandardized[16,3],
                            pheno8_out$results$parameters$unstandardized[13,3],
                            pheno8_out$results$parameters$unstandardized[14,3],
                            pheno8_out$results$parameters$unstandardized[15,3],
                            pheno8_out$results$parameters$unstandardized[17,3],
                            pheno8_out$results$parameters$unstandardized[18,3]),
                 ed3_p=c(pheno8_out$results$parameters$unstandardized[16,6],
                            pheno8_out$results$parameters$unstandardized[13,6],
                            pheno8_out$results$parameters$unstandardized[14,6],
                            pheno8_out$results$parameters$unstandardized[15,6],
                            pheno8_out$results$parameters$unstandardized[17,6],
                            pheno8_out$results$parameters$unstandardized[18,6])
                 )

tbl8


##generate forest plot to visualize the interaction

label <- c("less than high school","high school or some college","college degree or more")
mean  <- c(pheno8_out$results$parameters$unstandardized[4,3],
           pheno8_out$results$parameters$unstandardized[10,3],
           pheno8_out$results$parameters$unstandardized[16,3]) 
lower <- c(pheno8_out$results$parameters$ci.unstandardized[4,4],
           pheno8_out$results$parameters$ci.unstandardized[10,4],
           pheno8_out$results$parameters$ci.unstandardized[16,4])
upper <- c(pheno8_out$results$parameters$ci.unstandardized[4,8],
           pheno8_out$results$parameters$ci.unstandardized[10,8],
           pheno8_out$results$parameters$ci.unstandardized[16,8])

df <- data.frame(label, mean, lower, upper)

# reverses the factor level ordering for labels after coord_flip()
df$label <- factor(df$label, levels=rev(df$label))

library(ggplot2)
fp <- ggplot(data=df, aes(x=label, y=mean, ymin=lower, ymax=upper, label=mean)) +
  geom_pointrange() + 
  geom_hline(yintercept=0, lty=2) +  # add a dotted line at x=1 after flip
  coord_flip() +  # flip coordinates (puts labels on y axis)
  xlab("") + ylab("Effect of childhood inequality (95% CI)") +
  geom_text(vjust = -1, nudge_y = 0)+
  theme_bw() +
    theme(legend.box.background=element_blank(),
        legend.background=element_rect(fill="transparent",size=.5),
        axis.text.x=element_text(colour="black", size=18),
        axis.text.y=element_text(colour="black", size=18),
        axis.title.x=element_text(colour="black", size=18),
        axis.title.y=element_text(colour="black", size=18),
        plot.title=element_text(size=18),
        panel.background=element_blank(),
     #   panel.grid.major=element_blank(),
    #    panel.grid.minor=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.major.y=element_blank(),
    #    panel.grid.major.x=element_blank(),
    #    panel.grid.minor.x=element_blank(),
        panel.border=element_rect(colour="black", size=1),
        strip.background=element_blank(),
        strip.text=element_text(size=18),
        axis.line.x=element_line(size=1),
        axis.line.y=element_line(size=1),
        legend.text=element_text(size=18),
        legend.key.width=unit(3,"line"),
        legend.title=element_blank(),
        legend.direction="vertical",
        #       plot.title= element_text(hjust=-.45, vjust=2.12),
        legend.position=c("bottom"),
        legend.key=element_blank())# use a white background


print(fp)

##generate forest plot to visualize the interaction



label <- c("Full sample (N=69,973)","Men (n=34,423)","Women (n=35,550)",
           "GDP 1st quartile (n=17,778)","GDP 2nd quartile (n=17,596)", "GDP 3rd quartile (n=17,799)","GDP 4th quartile (n=16,800)",
           "Less than high school (n=31,965) ","High school or some college (n=24,108)","College degree or more (n=13,900)")
mean  <- c(0.202,
           pheno4_out$results$parameters$unstandardized[4,3],
           pheno4_out$results$parameters$unstandardized[10,3],
           pheno6_out$results$parameters$unstandardized[5,3],
           pheno6_out$results$parameters$unstandardized[12,3],
           pheno6_out$results$parameters$unstandardized[19,3],
           pheno6_out$results$parameters$unstandardized[26,3],
           pheno8_out$results$parameters$unstandardized[4,3],
           pheno8_out$results$parameters$unstandardized[10,3],
           pheno8_out$results$parameters$unstandardized[16,3]) 
lower <- c(0.161,
            pheno4_out$results$parameters$ci.unstandardized[4,4],
           pheno4_out$results$parameters$ci.unstandardized[10,4],
           pheno6_out$results$parameters$ci.unstandardized[5,4],
           pheno6_out$results$parameters$ci.unstandardized[12,4],
           pheno6_out$results$parameters$ci.unstandardized[19,4],
           pheno6_out$results$parameters$ci.unstandardized[26,4],
           pheno8_out$results$parameters$ci.unstandardized[4,4],
           pheno8_out$results$parameters$ci.unstandardized[10,4],
           pheno8_out$results$parameters$ci.unstandardized[16,4])
upper <- c(0.243,
           pheno4_out$results$parameters$ci.unstandardized[4,8],
           pheno4_out$results$parameters$ci.unstandardized[10,8],
           pheno6_out$results$parameters$ci.unstandardized[5,8],
           pheno6_out$results$parameters$ci.unstandardized[12,8],
           pheno6_out$results$parameters$ci.unstandardized[19,8],
           pheno6_out$results$parameters$ci.unstandardized[26,8],
           pheno8_out$results$parameters$ci.unstandardized[4,8],
           pheno8_out$results$parameters$ci.unstandardized[10,8],
           pheno8_out$results$parameters$ci.unstandardized[16,8])


df <- data.frame(label, mean, lower, upper)

# reverses the factor level ordering for labels after coord_flip()
df$label <- factor(df$label, levels=rev(df$label))

library(ggplot2)
fp <- ggplot(data=df, aes(x=label, y=mean, ymin=lower, ymax=upper, label=mean)) +
  geom_pointrange(size=.25,linewidth=.5) + 
  geom_hline(yintercept=0, linetype="dashed") +  # add a dotted line at x=1 after flip
  geom_vline(xintercept=7.75, lty=1) +
  geom_vline(xintercept=9.75, lty=1) +
  geom_vline(xintercept=3.75, lty=1) +
  annotate("label", x = 9.50, y = 0.05, label = "Female x Inequality = -0.091; p<0.01", fill="white", size=6/.pt)+
  annotate("label", x = 7.50, y = 0.05, label = "GDP x Inequality = -0.015; p<0.01", fill="white", size=6/.pt)+
  annotate("label", x = 3.50, y = 0.05, label = "Education x Inequality = -0.036; p<0.01", fill="white", size=6/.pt)+
  annotate("text", x= 10.35, y = -.80, label= "Panel A", size=6/.pt, fontface =2)+
  annotate("text", x= 9.35, y = -.80, label= "Panel B", size=6/.pt, fontface =2)+
  annotate("text", x= 7.35, y = -.80, label= "Panel C", size=6/.pt, fontface =2)+
  annotate("text", x= 3.35, y = -.80, label= "Panel D", size=6/.pt, fontface =2)+
  coord_flip(ylim=c(-.25,.55), clip="off") +  # flip coordinates (puts labels on y axis)
  xlab("") + ylab("Effect of childhood inequality (95% CI)") +
  geom_text(vjust = -1, nudge_y = 0, size=6/.pt)+
  theme_bw() +
    theme(legend.box.background=element_blank(),
        legend.background=element_rect(fill="transparent",size=.5),
        axis.text.x=element_text(colour="black", size=6),
        axis.text.y=element_text(colour="black", size=6),
        axis.title.x=element_text(colour="black", size=6),
        axis.title.y=element_text(colour="black", size=6),
        plot.title=element_text(size=6),
        panel.background=element_blank(),
     #   panel.grid.major=element_blank(),
    #    panel.grid.minor=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.major.y=element_blank(),
    #    panel.grid.major.x=element_blank(),
    #    panel.grid.minor.x=element_blank(),
        panel.border=element_rect(colour="black", size=.50),
        strip.background=element_blank(),
        strip.text=element_text(size=6),
        axis.line.x=element_line(size=.5),
        axis.line.y=element_line(size=.5),
        legend.text=element_text(size=6),
        legend.key.width=unit(1,"line"),
        legend.title=element_blank(),
        legend.direction="vertical",
        #       plot.title= element_text(hjust=-.45, vjust=2.12),
        legend.position=c("bottom"),
        legend.key=element_blank())# use a white background


print(fp)

ggsave("figure 1 main.jpeg", fp, dpi=500, width=11, height=11, units=c("cm"))


```

### Summary of the moderation analyses.

1.  The adverse effect of childhood inequality on depressive symptoms was stronger in women compared to men.
2.  The adverse effect of childhood inequality was strongest in individuals who grew up in either the lowest or highest gdp's. The effect was smallest in individuals growing up in GDP's that were between the 25th to 75th percentiles.
3.  The adverse effect of childhood inequality on depressive symptoms decreased in magnitude in individuals who obtained more education.

## Twin models: does childhood inequality moderate the genetic and environmental contributions to depressive symptoms?

### Twin correlations

| Zygosity | Number of pairs |  r   |
|----------|:---------------:|:----:|
| MZ       |     12,488      | .353 |
| DZ       |     18,304      | .195 |
| OS       |     11,546      | .138 |

: Twin correlations by zygosity

### ACE twin model without moderation

Depiction of the ACE model fit in MPLUS

![](ACE%20figure.png){fig-align="center"}

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: ACE model
#####load data IN Twin format


wide5<-read.csv("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/mplus trees/igems_dep_twin_13aug2024.csv")

wide5$ineqR<-round(wide5$ineq10)
wide5$ineqR2<-ifelse(wide5$ineqR<=6,6,wide5$ineqR)
wide5$ineqC<-wide5$ineq10-10

wide5$ineqC<-wide5$ineq10-10


twin<-wide5[c("dep1","dep2","sex1","sex2",
              "age",
              "ineqC",
              "zygos")]

twin$t1<-ifelse(twin$age<70,twin$age-70,0)
twin$t2<-ifelse(twin$age>=70,twin$age-70,0)

twin$zygos2[twin$zygos==1]<-1
twin$zygos2[twin$zygos>=2]<-2


mz<-subset(twin, zygos==1 & !is.na(dep1) & !is.na(dep2))
describe(mz)
cor.test(mz$dep1, mz$dep2)

dz<-subset(twin, zygos==2 & !is.na(dep1) & !is.na(dep2))
describe(dz)
cor.test(dz$dep1, dz$dep2)

os<-subset(twin, zygos==3 & !is.na(dep1) & !is.na(dep2))
describe(os)
cor.test(os$dep1, os$dep2)

#### univariate ACE model
uniACE<-mplusObject(
  TITLE = "univariate ACE",
  
  VARIABLE = "
  USEVARIABLES=
  dep1 dep2
  sex1 sex2
  t1 t2
  ineqC
  zygos2;
  GROUPING = zygos2(1= mz 2 = dz)
  ",
  ANALYSIS="
  MODEL=NOCOVARIANCES;
  ESTIMATOR=ML;
",
  MODEL= "
 [dep1-dep2*50] (a1);
  dep1-dep2@0;
  a1 by dep1*5 (a2);
  a2 by dep2*5 (a2);
  c1 by dep1*5 (a3);
  c2 by dep2*5 (a3);
  e1 by dep1*5 (a4);
  e2 by dep2*5 (a4);
  a1-e2@1;
  [a1-e2@0];
  a1 with a2@1;
  c1 with c2@1;
  
dep1 on 
t1 (m1)
t2 (m2)
sex1 (m4)
ineqC (m5);
  
dep2 on
t1 (m1)
t2 (m2)
sex2 (m4)
ineqC (m5);

  MODEL dz:
  a1 with a2@.50;
c1 with c2@1;





  
model constraint:

    new(aV cV eV VV
    sA sC sE);
    
    aV=a2^2;
    cV=a3^2;
    eV=a4^2;
    VV=aV+cV+eV;
    sA=aV/VV;
    sC=cV/VV;
    sE=eV/VV;
  ",
  
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL ",
  rdata=twin)

uniACE_out <- mplusModeler(uniACE, 
                           dataout="uniace.dat",
                           hashfilename = FALSE,
                           modelout = "IGEMS uni ace dep.inp", 
                           run = 1, 
                           writeData=c("always"))


```

Results from the full ACE model

| Component | Unstandardized variance | 95% CI | Standardized variance | 95% CI |
|----|----|----|----|----|
| Additive Genetic (A) | 32.15 | \[30.49; 33.80\] | 33% | \[31; 35\] |
| Common environmental (C) | 0.00 | \[-.002; .002\] | 0% |  |
| Non-shared environmental (E) | 65.40 | \[63.82; 66.97\] | 67% | \[66; 69\] |
| Total Variance (V) | 97.54 | \[96.48; 98.60\] |  |  |

### ACE twin model with moderation

Depiction of the ACE moderation model.

![](ace%20mod%20figure.png){fig-align="center"}

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: ACE moderation model
uniACE_m2<-mplusObject(
  TITLE = "univariate ACE with mean moderation",
  
  VARIABLE = "
  USEVARIABLES=
  dep1 dep2
  sex1 sex2
  t1 t2
  ineqC
  zygos2;

  GROUPING = zygos2(1= mz 2 = dz);
  constraint= ineqC;

  ",
  
  
  ANALYSIS="

  MODEL=NOCOVARIANCES;
  ESTIMATOR=ML;
  

",
  MODEL= "

dep1 on t1 (m1);
dep1 on t2 (m2);
dep1 on ineqC (m3);
dep1 on sex1 (m4);



dep2 on t1 (m1);
dep2 on t2 (m2);
dep2 on ineqC (m3);
dep2 on sex2 (m4);


  

[dep1 dep2] (m);

dep1 (v1); 
dep2 (v2);

dep1 with dep2 (c1);


  MODEL dz:
  
 dep1 with dep2 (c2);
 


  model constraint:

    new(a*5 c*1 e*5 
    t u v 
    A20 C20 E20 V20
    A5 C5 E5 V5
    A10 C10 E10 V10
    A15 C15 E15 V15);
    v1=(a+t*ineqc)**2 + (c+u*ineqc)**2 + (e+v*ineqc)**2;
    v2=(a+t*ineqc)**2 + (c+u*ineqc)**2 + (e+v*ineqc)**2;
    c1=(a+t*ineqc)*(a+t*ineqc) + (c+u*ineqc)*(c+u*ineqc);
    c2=0.5*(a+t*ineqc)*(a+t*ineqc) + (c+u*ineqc)*(c+u*ineqc);

    A10=(a+t*0)^2;
    C10=(c+u*0)^2;
    E10=(e+v*0)^2;
    V10=A10+C10+E10;   
    
    A5=(a+t*(-5))^2;
    C5=(c+u*(-5))^2;
    E5=(e+v*(-5))^2;
    V5=A5+C5+E5;   

    A15=(a+t*5)^2;
    C15=(c+u*5)^2;
    E15=(e+v*5)^2;
    V15=A15+C15+E15;   

    A20=(a+t*10)^2;
    C20=(c+u*10)^2;
    E20=(e+v*10)^2;
    V20=A20+C20+E20;   

  ",
  
  
  
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL ",
  rdata=twin)

uniACE_m2_out <- mplusModeler(uniACE_m2, 
                              dataout="ACEmod.dat",
                              hashfilename = FALSE,
                              modelout = "IGEMS uni ace ineq mod.inp", 
                              run = 1, 
                              writeData=c("always"))


```

Parameter estimates from the moderation model

| Moderation parameter | Estimate |       95% CI       |    p     |
|----------------------|:--------:|:------------------:|:--------:|
| **A1**               | **.057** | **\[.004; .110\]** | **.036** |
| C1                   |   .028   |  \[-.227; .284\]   |   .827   |
| E1                   |   .007   |  \[-.020; .033\]   |   .624   |

Childhood inequality significantly moderated the additive genetic variance in depressive symptoms. The amount of variance accounted for by additive genetic factors was larger in individuals growing up in countries with higher income inequality.

Plot of the estimated unstandardized variance components by income inequality

```{r}
#| warning: false
#| label: plot of the ACE moderation model
ACEmod<-data.frame(inequality=c(5,10,15,20),
                   A=c(uniACE_m2_out$results$parameters$unstandardized[37,3],
                       uniACE_m2_out$results$parameters$unstandardized[41,3],
                       uniACE_m2_out$results$parameters$unstandardized[45,3],
                       uniACE_m2_out$results$parameters$unstandardized[33,3]),
                   
                   C=c(uniACE_m2_out$results$parameters$unstandardized[38,3],
                       uniACE_m2_out$results$parameters$unstandardized[42,3],
                       uniACE_m2_out$results$parameters$unstandardized[46,3],
                       uniACE_m2_out$results$parameters$unstandardized[34,3]),
                   
                   E=c(uniACE_m2_out$results$parameters$unstandardized[39,3],
                       uniACE_m2_out$results$parameters$unstandardized[43,3],
                       uniACE_m2_out$results$parameters$unstandardized[47,3],
                       uniACE_m2_out$results$parameters$unstandardized[35,3]),
                   
                   V=c(uniACE_m2_out$results$parameters$unstandardized[40,3],
                       uniACE_m2_out$results$parameters$unstandardized[44,3],
                       uniACE_m2_out$results$parameters$unstandardized[48,3],
                       uniACE_m2_out$results$parameters$unstandardized[36,3]))


ACEmod$h2<-ACEmod$A/ACEmod$V

A<-ACEmod[c("inequality","A")]
A$variance<-A$A
A$varCOMP<-"Additive Genetic"
A$A<-NULL

C<-ACEmod[c("inequality","C")]
C$variance<-C$C
C$varCOMP<-"Common Environmental"
C$C<-NULL

E<-ACEmod[c("inequality","E")]
E$variance<-E$E
E$varCOMP<-"Nonshared Environmental"
E$E<-NULL

V<-ACEmod[c("inequality","V")]
V$variance<-V$V
V$varCOMP<-"Total Variance"
V$V<-NULL

ACEmod1a<-rbind(A,C,E,V)

ACEmod1a$varCOMP<-factor(ACEmod1a$varCOMP,
                         levels= c("Total Variance",
                                 "Nonshared Environmental",
                                 "Additive Genetic",
                                 "Common Environmental"))
#scale_color_manual(values=c("black","blue","red","green"))

ACEmod1a$varianceR<-round(ACEmod1a$variance,1)

modPLOT<-ggplot(ACEmod1a, aes(x=inequality, y=variance, color=varCOMP, label=varianceR)) +
  geom_line(size=1)+
  theme_bw()+
  geom_text(vjust = -1, nudge_y = 0, size=2)+
  geom_point()+
  scale_color_manual(values=c("black","blue","red","green"))+
  scale_x_continuous(name="Childhood inequality (top 1% percentage)", breaks=c(seq(5,20,5)))+
  scale_y_continuous(name="Raw variance", breaks=c(seq(0,110,10)))+
  theme(legend.box.background=element_blank(),
        legend.background=element_rect(fill="transparent",size=.5),
        axis.text.x=element_text(colour="black", size=8),
        axis.text.y=element_text(colour="black", size=8),
        axis.title.x=element_text(colour="black", size=8),
        axis.title.y=element_text(colour="black", size=8),
        plot.title=element_text(size=14),
        panel.background=element_blank(),
        panel.grid.major=element_blank(),
        panel.grid.minor=element_blank(),
        panel.grid.minor.y=element_blank(),
        panel.grid.major.y=element_blank(),
        panel.grid.major.x=element_blank(),
        panel.grid.minor.x=element_blank(),
        panel.border=element_rect(colour="black", size=1),
        strip.background=element_blank(),
        strip.text=element_text(size=8),
        axis.line.x=element_line(size=1),
        axis.line.y=element_line(size=1),
        legend.text=element_text(size=8),
        legend.key.width=unit(3,"line"),
        legend.title=element_blank(),
        legend.direction="vertical",
        #       plot.title= element_text(hjust=-.45, vjust=2.12),
        legend.position=c("bottom"),
        legend.key=element_blank())

modPLOT

print(modPLOT)

ggsave("figure 2 main.jpeg", modPLOT, dpi=500, width=11, height=11, units=c("cm"))

```

## Phenotypic MPLUS trees

The phenotypic analyses, and prior research, suggest that the adverse effect of childhood inequality on depressive symptoms may be moderated by factors such as gross domestic product, education, sex, and age. We utilized an exploratory data-driven approach to identify heterogeneity in the association between childhood inequality and depressive symptoms.

Mplus Tree models (Serang et al., 2021) using recursive partitioning to identify groups of people where the estimate of childhood inequality on depressive symptoms is as similar as possible.

Advantages of the SEMtrees in the program MPLUS trees because it blends theory-based and data-driven modeling. First, you specify a structural equation model based off of theory. Although the first SEM model is very simple (basic regression model regressing current depressive symptoms on childhood inequaltiy) this approach allows for the specification of more complex SEM models (later biometric ACE models to examine complex GxE questions).This approach also allows us to account for the twin nature of the data by clustering individuals within pairs.

The first step is to define the SEM model. The phenotypic model can be specified with the following equation:

$$
dep_i = intercept + \beta_inequality * inequal_i + \epsilon_i
$$ In this model twins were nested within twin pairs.

This model was fit in MPLUS with the following code:

```{r}
#| label: mplus phenotypic model
#| warning: false
#| include: false
#| echo: TRUE



#create unique pairid for clustering in mplus

#mplus model
mod1<-mplusObject(
  TITLE = "childhood inequality on dep",

  VARIABLE = "
  USEVARIABLES=
  depT ineq10;
  
  cluster is pairN;
  ",
  
  
  ANALYSIS="
ESTIMATOR=MLR;
TYPE=COMPLEX;
",
  MODEL= "

depT on ineq10;

  ",
  
  
  
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL stand ",
  rdata=data)

mod1_out <- mplusModeler(mod1, 
                         dataout="igems childhood on dep.dat",
                         hashfilename = FALSE,
                         modelout = "childhood inequality on dep.inp", 
                         run = 1, 
                         writeData=c("always"))

```

```{r}
#| label: output from the phenotypic model

tbl1<-data.frame(effect= "childhood inequality (per 1% increase) on depressive symptoms",
                 N=mod1_out$results$summaries$Observations,
                 estimate=mod1_out$results$parameters$unstandardized[1,3],
                 low=mod1_out$results$parameters$ci.unstandardized[1,4],
                 upp=mod1_out$results$parameters$ci.unstandardized[1,8],
                 p=mod1_out$results$parameters$unstandardized[1,6],
                 r2=mod1_out$results$parameters$r2[1,2])
  
tbl1


```

Individuals living in countries with higher income inequality reported more depressive symptoms. The overall magnitude of this effect was very small as childhood income inequality explained less than one percent (r2=0.1%) of the the total variance in depressive symptoms.

```{r}
#fit.pheno.0001 = MplusTrees(mod1, data, group=~id2, 
#rPartFormula =~sex0+gdp10R+ageR+eduC, control=rpart.control(minbucket = 1000, cp=.0001), se=T, psplit=T, #palpha = .05)
#summary(fit.pheno.0001)

#fit.pheno.00025 = MplusTrees(mod1, data, group=~id2, 
#rPartFormula =~sex0+gdp10R+ageR+eduC, control=rpart.control(minbucket = 1000, cp=.00025), se=T, #psplit=T, palpha = .05)
#summary(fit.pheno.00025)

#fit.pheno.0005 = MplusTrees(mod1, data, group=~id2, 
#rPartFormula =~sex0+gdp10R+ageR+eduC, control=rpart.control(minbucket = 1000, cp=.0005), se=T, psplit=T, #palpha = .05)
#summary(fit.pheno.0005)

#fit.pheno.00075 = MplusTrees(mod1, data, group=~id2, 
#rPartFormula =~sex0+gdp10R+ageR+eduC, control=rpart.control(minbucket = 1000, cp=.00075), se=T, psplit=T, palpha = .05)
#summary(fit.pheno.00075)

#fit.pheno.001 = MplusTrees(mod1, data, group=~id2, 
#rPartFormula =~sex0+gdp10R+ageR+eduC, control=rpart.control(minbucket = 1000, cp=.001), se=T, psplit=T, #palpha = .05)
#summary(fit.pheno.001)

```

Next, I ran the SEM trees in the MPLUS trees framework. In this approach I specify a list of covariates to consider partitioning the data on. This SEM decision tree approach uses recursive partitioning to repeatedly divide the covariate space. This is done by testing all splits of the predictors in the covariate and choosing the split that makes the parameter estimate in that split as homogeneous as possible. If a split is retained then the two daughter nodes are then subjected to the same splitting procedure (e.g., the remaining covariates are split again) until there is no more improvement in model fit.

The MPLUS trees models are advantageous because it allows the data-driven partitioning approach to be applied to complex specified models.

The two log-likelihood (-2logL) is estimated for the full model including all individuals. Covariates are specified and the data is split along all possible levels of that covariate. For example, if we chose age as a continuous covariate that was rounded to the nearest year the range for IGEMS is 22 to 103. The data will be split along all possible splits for age which would result in 80 possible split options (81-1).

So the data is split along all possible levels of the covariate specified and the model is re-run. For each split of the -2logL is obtained. Since these are equivalent to multi-group models, the -2logL from the split is compared to the -2logL of the full model. The two models can be compared via the likelihood ratio test. The partition of the covariate that results in the largest improvement in model fit is retained. The process is then repeated at each daughter node. This partitioning continues until there are no longer any significant improvements in model fit.

Specifying the criterion to denote a relative improvement in model fit that is needed in order to retain a split in the data.

complexity parameter (cp)

The complexity parameter corresponds to the proportional improvement in the -2logL that is needed to preform a split. For example, if the -2logL for the full model was 1,000 and we specified the cp to be .01, then we would need a candidate split to improve by -2logL of 10 to retain that split.

According the the Serang et al., 2021 MPLUS tree article it is best to run the model with multiple cp values. They suggest to start with a smaller cp value which will typically yield a very complex tree. Then you increase the cp value in a step wise fashion to "prune branches from your tree" that may be too complex. In order further prevent over fitting our model I used the probability value to determine the significance of a split. This psplit function specifies utilizes the likelihood ratio test to determine if a split significantly improves the model at a p\<.05. Lastly, I specified that the minimal number of individuals in a terminal node is n=1,000.

Here are the variables that were included in the MPLUS trees partitioning

Age: rounded to the nearest year

GDP: GDP/1000 rounded to the nearest 1,000

Education: broken down into 3 categories: 1 = less than high school, 2=high school or more, 3= college degree or more

Sex: either male or female

### MPLUS tree for cp=.0001

![CP=.0001](phenotpyic%20diagrams/pheno_cp_0001.png){fig-align="center" width="9187"}

### MPLUS tree for cp=.00025

![CP=.00025](phenotpyic%20diagrams/pheno_cp_00025.png){fig-align="center" width="9000"}

### MPLUS tree for cp=.0005

![CP=.0005](phenotpyic%20diagrams/pheno_cp_0005.png){width="5000"}

### MPLUS tree for cp=.00075

![CP=.00075](phenotpyic%20diagrams/pheno_cp_00075.png){fig-align="center"}

### MPLUS tree for cp=.001

![CP=.001](phenotpyic%20diagrams/pheno_cp_001.png){fig-align="center"}

### Summary of MPLUS tree phenotypic analysis

I argue that adapting a complexity parameter of .0005, with a likelihood ratio test threshold of p\<.05, and a minimum node of n=1,000 provides the most parsimonious solution that we can interpret.

In this solution the effect of childhood inequality on depressive symptoms was moderated by sex and GDP. The adverse effect of childhood inequality was of largest magnitude for men who grew up in either very low gdp (7,500 or less) or a high GDP (\>=15,500).

For women, the adverse effect of childhood inequality was the largest in low GDP (\<7,500). In higher GDPs childhood inequality was associated with lower depressive symptoms (beta= -.218).

## Twin MPLUS trees

Next, I utilized the MPLUS trees covariate partitioning to examine whether Childhood inequality, GDP, age, and sex education moderate the genetic and environmental contributions to the variance in depressive symptoms.

I started with a standard ACE without any adjustments. The figure for the ACE model is presented below:

![ACE model specified in mplus trees analysis](ace%20diagrams/ace%20model.png){fig-align="center"}

Next, I ran the MPLUS trees modeling with twin pair as the id variable. Because sex was identified as an important moderator from the phenotypic analyses (and identified as an important moderator in our cross-sectional paper in Psychological Medicine) I restricted the analyses to same-sex pairs. I used the following covariates to partition the data

Age: rounded to the nearest year

GDP: GDP/1000 rounded to the nearest 1,000

Childhood inequality: rounded to the nearest 1%

Sex: either male or female

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: ACE MPLUS MODEL

twin2<-read.csv("/Users/drew/Library/CloudStorage/OneDrive-UniversityofSouthernCalifornia/IGEMS 2023/inequality gxe depression/inequality on dep 21aug2024/igems dep twin mplus trees 26aug2024.csv")

twin2$id2<-as.integer(row.names(twin2))

twin2$gdpR<-ifelse(is.na(twin2$gdp10R1),twin2$gdp10R2, twin2$gdp10R1)
twin2$ineqR<-round(twin2$ineq10)

twin3<-subset(twin2, zygos<3, c("pairN","id2","dep1","dep2","zygos",
                                "gdpR","ineqR","age","sex1","sex2"))




#### univariate ACE model
uniACE<-mplusObject(
  TITLE = "univariate ACE",
  
  VARIABLE = "
  USEVARIABLES=
  dep1 dep2
  zygos;
  GROUPING = zygos(1= mz 2 = dz)
  ",
  ANALYSIS="
  MODEL=NOCOVARIANCES;
  ESTIMATOR=ML;
",
  MODEL= "
 [dep1-dep2*50] (a1);
  dep1-dep2@0;
  a1 by dep1*5 (a2);
  a2 by dep2*5 (a2);
  c1 by dep1*5 (a3);
  c2 by dep2*5 (a3);
  e1 by dep1*5 (a4);
  e2 by dep2*5 (a4);
  a1-e2@1;
  [a1-e2@0];
  a1 with a2@1;
  c1 with c2@1;
  
  MODEL dz:
  a1 with a2@.50;
c1 with c2@1;





  
model constraint:

    new(aV cV eV VV
    sA sC sE);
    
    aV=a2^2;
    cV=a3^2;
    eV=a4^2;
    VV=aV+cV+eV;
    sA=aV/VV;
    sC=cV/VV;
    sE=eV/VV;
  ",
  
  OUTPUT= "tech4 tech1 tech2 tech3 sampstat CINTERVAL ",
  rdata=twin3)

uniACE_out <- mplusModeler(uniACE, 
                           dataout="modace2.dat",
                           hashfilename = FALSE,
                           modelout = "IGEMS dep ace tree.inp", 
                           run = 1, 
                           writeData=c("always"))

```

```{r}
#| warning: false
#| include: false
#| echo: TRUE
#| label: ACE MPLUS TREES
 
fit.ace.0001 = MplusTrees(uniACE, twin3, group=~id2, 
rPartFormula =~sex1+gdpR+age+ineqR, control=rpart.control(minbucket = 1000, cp=.0001))
#summary(fit.ace.0001)

#fit.ace.00025 = MplusTrees(uniACE, twin3, group=~id2, 
#rPartFormula =~sex1+gdpR+age+ineqR, control=rpart.control(minbucket = 1000, cp=.00025))
#summary(fit.ace.00025)

#fit.ace.0005 = MplusTrees(uniACE, twin3, group=~id2, 
#rPartFormula =~sex1+gdpR+age+ineqR, control=rpart.control(minbucket = 1000, cp=.0005))
#summary(fit.ace.0005)

#fit.ace.00075 = MplusTrees(uniACE, twin3, group=~id2, 
#rPartFormula =~sex1+gdpR+age+ineqR, control=rpart.control(minbucket = 1000, cp=.00075))
#summary(fit.ace.00075)

```

### ACE MPLUS tree for cp=.001

```{r}
#| fig-width: 12
#| fig-height: 12

plot(fit.ace.0001)


```

### ACE MPLUS tree for cp=.00025

![CP=.00025](ace%20diagrams/ace_cp_00025.png){fig-align="center"}

### ACE MPLUS tree for cp=.0005

![CP=.0005](ace%20diagrams/ace_cp_0005.png){fig-align="center"}

### ACE MPLUS tree for cp=.00075

![](ace%20diagrams/pheno_cp_00075.png){fig-align="center"}
